<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maintenance Plan Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- jsPDF for PDF Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .tab-button.active {
            border-bottom-color: #4f46e5;
            color: #4f46e5;
            font-weight: 600;
        }
        .modal {
            transition: opacity 0.3s ease;
        }
        .chart-bar {
            transition: height 0.5s ease-out;
        }
        /* Simple spinner */
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #4f46e5;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #loading-overlay {
            transition: opacity 0.3s ease;
        }
        .year-view-grid {
            grid-template-columns: 200px repeat(52, minmax(30px, 1fr));
        }
        /* Asset Tree Styles */
        .asset-node {
            display: flex;
            align-items: center;
            padding: 4px 8px;
            border-radius: 6px;
            transition: background-color 0.2s;
        }
        .asset-node:hover {
            background-color: #f4f4f5; /* gray-100 */
        }
        .asset-node-content {
            flex-grow: 1;
            display: flex;
            align-items: center;
        }
        .toggle-expand-btn {
            width: 20px;
            height: 20px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-family: monospace;
            font-weight: bold;
            font-size: 14px;
            color: #4f46e5; /* indigo-600 */
        }
        .toggle-expand-btn.empty {
            color: transparent; /* No children */
            cursor: default;
        }
        .asset-actions {
            display: flex;
            align-items: center;
            gap: 8px;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .asset-node:hover .asset-actions {
            opacity: 1;
        }
        .asset-action-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 2px;
            border-radius: 4px;
        }
        .asset-action-btn:hover {
            background-color: #e4e4e7; /* gray-200 */
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <div id="loading-overlay" class="fixed inset-0 bg-white/70 backdrop-blur-sm flex items-center justify-center z-50">
        <div class="loader"></div>
    </div>

    <div class="min-h-screen p-4 sm:p-6 lg:p-8">
        <div class="max-w-7xl mx-auto">
            <!-- Header -->
            <header class="mb-4">
                <div class="flex flex-col sm:flex-row justify-between sm:items-center">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-900">Maintenance Plan</h1>
                        <p class="text-gray-500 mt-1">A dynamic and visual overview of maintenance tasks by RLC.</p>
                    </div>
                    <div class="mt-4 sm:mt-0">
                        <label for="location-selector" class="block text-sm font-medium text-gray-700">Select Location</label>
                        <select id="location-selector" class="mt-1 block w-full sm:w-64 pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md"></select>
                    </div>
                </div>
            </header>

            <!-- Navigation Tabs -->
            <div class="mb-6 border-b border-gray-200">
                <nav class="-mb-px flex space-x-6 overflow-x-auto" id="nav-tabs">
                    <button data-tab="dashboard" class="tab-button active shrink-0 py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">Dashboard</button>
                    <button data-tab="planning" class="tab-button shrink-0 py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">Maintenance Planning</button>
                    <button data-tab="weekly" class="tab-button shrink-0 py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">Weekly View</button>
                    <button data-tab="year" class="tab-button shrink-0 py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">Year View</button>
                    <button data-tab="reports" class="tab-button shrink-0 py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">Reports</button>
                    <button data-tab="settings" class="tab-button shrink-0 py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">Settings</button>
                </nav>
            </div>

            <!-- Content Area -->
            <main id="content-area">
                <!-- Dashboard View -->
                <div id="dashboard-view" class="tab-content">
                    <!-- Dashboard Filters -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6 bg-white p-4 rounded-lg shadow-sm">
                        <div>
                            <label for="filter-asset" class="block text-sm font-medium text-gray-700">Asset</label>
                            <select id="filter-asset" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md"></select>
                        </div>
                        <div>
                            <label for="filter-type" class="block text-sm font-medium text-gray-700">Maintenance Type</label>
                            <select id="filter-type" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md"></select>
                        </div>
                        <div>
                            <label for="filter-status" class="block text-sm font-medium text-gray-700">Status</label>
                            <select id="filter-status" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md"></select>
                        </div>
                        <div class="flex items-end">
                            <button id="reset-filters" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-md text-sm transition">Reset Filters</button>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Status Overview -->
                        <div class="lg:col-span-1 bg-white p-6 rounded-lg shadow-sm">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Status Overview</h3>
                            <div id="status-chart" class="space-y-4"></div>
                        </div>
                        <!-- Workload Per Week -->
                        <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-sm">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Workload per Week (Hours)</h3>
                            <div id="workload-chart" class="h-64 flex items-end space-x-1 overflow-x-auto p-2 bg-gray-50 rounded-md"></div>
                        </div>
                    </div>
                     <!-- Open/Postponed Tasks -->
                    <div class="mt-6 bg-white p-6 rounded-lg shadow-sm">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Urgent Tasks (Open or Postponed)</h3>
                        <div id="urgent-tasks-list" class="overflow-x-auto"></div>
                    </div>
                </div>

                <!-- Maintenance Planning View -->
                <div id="planning-view" class="tab-content hidden">
                    <div class="bg-white p-6 rounded-lg shadow-sm">
                        <div class="flex justify-between items-center mb-4 flex-wrap gap-4">
                            <h3 class="text-lg font-semibold text-gray-900">All Maintenance Tasks</h3>
                            <div class="flex items-center space-x-2 flex-wrap gap-2">
                                <input type="file" id="csv-file-input" class="hidden" accept=".csv">
                                <button id="download-template-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-md flex items-center">
                                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                                    Download Template
                                </button>
                                <button id="import-csv-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md flex items-center">
                                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                                    Import from CSV
                                </button>
                                <button id="export-csv-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md flex items-center">
                                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                                    Export to CSV
                                </button>
                                <button id="add-task-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md flex items-center">
                                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                                    Add Task
                                </button>
                            </div>
                        </div>
                        <p class="text-sm text-gray-500 mt-2">
                            Om taken te importeren, download eerst de template. Vul de data in en zorg ervoor dat de 'asset' waarden exact overeenkomen met de waarden in de Settings.
                        </p>
                        <div class="overflow-x-auto mt-4">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Asset</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Task</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Frequency</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Time (hrs)</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="planning-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Weekly Planning View -->
                <div id="weekly-view" class="tab-content hidden">
                    <div class="bg-white p-6 rounded-lg shadow-sm">
                        <div class="md:flex justify-between items-center mb-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4 md:mb-0">Weekly Task Overview</h3>
                            <div class="flex items-center space-x-2">
                                <label for="week-selector" class="text-sm font-medium">Select Week:</label>
                                <input type="number" id="week-selector" min="1" max="52" class="w-24 border-gray-300 rounded-md shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div class="lg:col-span-2">
                                <h4 class="text-md font-semibold mb-2" id="weekly-task-title">Tasks for Week X</h4>
                                <div class="overflow-x-auto border rounded-lg">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Asset</th>
                                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Task</th>
                                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Time (hrs)</th>
                                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                            </tr>
                                        </thead>
                                        <tbody id="weekly-task-list" class="bg-white divide-y divide-gray-200"></tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="lg:col-span-1">
                                <h4 class="text-md font-semibold mb-2" id="weekly-hours-title">Total Hours for Week X</h4>
                                <div id="weekly-hours-summary" class="space-y-3"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Year View -->
                <div id="year-view" class="tab-content hidden">
                    <div class="bg-white p-6 rounded-lg shadow-sm overflow-x-auto">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Yearly Task Schedule</h3>
                        <div id="year-view-grid-container" class="min-w-max"></div>
                    </div>
                </div>

                <!-- Reports View -->
                <div id="reports-view" class="tab-content hidden">
                    <div class="bg-white p-6 rounded-lg shadow-sm">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Generate Report</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                            <div>
                                <label for="report-type-selector" class="block text-sm font-medium text-gray-700">Report Type</label>
                                <select id="report-type-selector" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                    <option value="weekly">Weekly</option>
                                    <option value="monthly">Monthly</option>
                                    <option value="quarterly">Quarterly</option>
                                </select>
                            </div>
                            <div>
                                <label for="report-period-selector" class="block text-sm font-medium text-gray-700">Period</label>
                                <select id="report-period-selector" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md"></select>
                            </div>
                            <div>
                                <button id="generate-pdf-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md flex items-center justify-center">
                                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                    Generate PDF
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Settings View -->
                <div id="settings-view" class="tab-content hidden">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Location Management -->
                        <div class="bg-white p-6 rounded-lg shadow-sm">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Add New Location</h3>
                            <form id="add-location-form" class="space-y-4">
                                <div>
                                    <label for="new-location-name" class="block text-sm font-medium text-gray-700">Location Name</label>
                                    <input type="text" id="new-location-name" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                </div>
                                <div class="flex justify-end">
                                    <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md">Add Location</button>
                                </div>
                            </form>
                        </div>

                        <div class="bg-white p-6 rounded-lg shadow-sm">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Manage Location & Assets</h3>
                            <div>
                                <label for="edit-location-selector" class="block text-sm font-medium text-gray-700">Select Location to Manage</label>
                                <div class="flex items-center gap-2 mt-1">
                                    <select id="edit-location-selector" class="block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md"></select>
                                    <button id="rename-location-btn" title="Rename Location" disabled class="flex-shrink-0 bg-blue-500 hover:bg-blue-600 text-white font-bold p-2 rounded-md disabled:opacity-50 disabled:cursor-not-allowed">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                                    </button>
                                    <button id="delete-location-btn" title="Delete Location" disabled class="flex-shrink-0 bg-red-600 hover:bg-red-700 text-white font-bold p-2 rounded-md disabled:opacity-50 disabled:cursor-not-allowed">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                    </button>
                                </div>
                            </div>
                            <div id="asset-manager" class="mt-6 hidden">
                                <!-- Asset tree will be rendered here -->
                            </div>
                        </div>

                        <!-- Global Settings -->
                        <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-3 gap-6">
                            <!-- Maintenance Types -->
                            <div class="bg-white p-6 rounded-lg shadow-sm">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="text-lg font-semibold text-gray-900">Maint. Types</h3>
                                    <button class="add-setting-btn bg-blue-500 hover:bg-blue-600 text-white text-sm font-bold py-1 px-3 rounded-md" data-list-key="maintenanceTypes">Add</button>
                                </div>
                                <div id="maintenanceTypes-list" class="space-y-2"></div>
                            </div>
                            <!-- Frequencies -->
                            <div class="bg-white p-6 rounded-lg shadow-sm">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="text-lg font-semibold text-gray-900">Frequencies</h3>
                                    <button class="add-setting-btn bg-blue-500 hover:bg-blue-600 text-white text-sm font-bold py-1 px-3 rounded-md" data-list-key="frequencies">Add</button>
                                </div>
                                <div id="frequencies-list" class="space-y-2"></div>
                            </div>
                            <!-- Statuses -->
                            <div class="bg-white p-6 rounded-lg shadow-sm">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="text-lg font-semibold text-gray-900">Statuses</h3>
                                    <button class="add-setting-btn bg-blue-500 hover:bg-blue-600 text-white text-sm font-bold py-1 px-3 rounded-md" data-list-key="statuses">Add</button>
                                </div>
                                <div id="statuses-list" class="space-y-2"></div>
                            </div>
                        </div>

                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Add/Edit Task Modal -->
    <div id="task-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden opacity-0 z-50">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center pb-3 border-b">
                <h3 id="modal-title" class="text-2xl font-bold">Add New Task</h3>
                <button id="close-modal-btn" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <form id="task-form" class="mt-4 space-y-4">
                <input type="hidden" id="task-id">
                
                <div>
                    <label for="asset" class="block text-sm font-medium text-gray-700">Asset</label>
                    <select id="asset" required class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md"></select>
                </div>
                
                <div>
                    <label for="task-description" class="block text-sm font-medium text-gray-700">Task Description</label>
                    <input type="text" id="task-description" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                    <div>
                        <label for="maintenance-type" class="block text-sm font-medium text-gray-700">Maintenance Type</label>
                        <select id="maintenance-type" required class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md"></select>
                    </div>
                    <div>
                        <label for="frequency" class="block text-sm font-medium text-gray-700">Frequency</label>
                        <select id="frequency" required class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md"></select>
                    </div>
                </div>
                <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                    <div>
                        <label for="start-week" class="block text-sm font-medium text-gray-700">Start Week</label>
                        <input type="number" id="start-week" min="1" max="52" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="required-time" class="block text-sm font-medium text-gray-700">Required Time (hours)</label>
                        <input type="number" id="required-time" step="0.1" min="0" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                </div>
                <div>
                    <label for="status" class="block text-sm font-medium text-gray-700">Status</label>
                    <select id="status" required class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md"></select>
                </div>
                <div class="pt-4 border-t flex justify-end">
                    <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md">Save Task</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Custom Alert Modal -->
    <div id="alert-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden opacity-0 z-50">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-sm shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 id="alert-title" class="text-lg leading-6 font-medium text-gray-900">Notification</h3>
                <div class="mt-2 px-7 py-3">
                    <p id="alert-message" class="text-sm text-gray-500 whitespace-pre-wrap">Alert message goes here.</p>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="alert-ok-btn" class="px-4 py-2 bg-indigo-600 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        OK
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Confirm Modal -->
    <div id="confirm-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden opacity-0 z-50">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-sm shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-yellow-100">
                    <svg class="h-6 w-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                </div>
                <h3 class="text-lg leading-6 font-medium text-gray-900 mt-2">Confirmation</h3>
                <div class="mt-2 px-7 py-3">
                    <p id="confirm-message" class="text-sm text-gray-500">Confirmation message goes here.</p>
                </div>
                <div class="items-center px-4 py-3 sm:flex sm:flex-row-reverse">
                    <button id="confirm-yes-btn" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:ml-3 sm:w-auto sm:text-sm">
                        Yes
                    </button>
                    <button id="confirm-no-btn" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:w-auto sm:text-sm">
                        No
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Prompt Modal -->
    <div id="prompt-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden opacity-0 z-50">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-sm shadow-lg rounded-md bg-white">
            <form id="prompt-form">
                <div class="mt-3">
                    <h3 id="prompt-title" class="text-lg leading-6 font-medium text-gray-900">Input Required</h3>
                    <div class="mt-2 px-1 py-3">
                        <p id="prompt-message" class="text-sm text-gray-500 mb-3">Prompt message goes here.</p>
                        <input type="text" id="prompt-input" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required>
                    </div>
                    <div class="items-center px-4 py-3 sm:flex sm:flex-row-reverse">
                        <button type="submit" id="prompt-ok-btn" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:ml-3 sm:w-auto sm:text-sm">
                            OK
                        </button>
                        <button type="button" id="prompt-cancel-btn" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:w-auto sm:text-sm">
                            Cancel
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, getDoc, getDocs, setDoc, addDoc, deleteDoc, runTransaction, updateDoc, writeBatch, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        // --- DATABASE CONFIGURATION ---
        // These variables are injected by the environment.
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';


        document.addEventListener('DOMContentLoaded', async () => {
            // --- FIREBASE SETUP ---
            let db, auth, userId;
            try {
                 if (!firebaseConfig || Object.keys(firebaseConfig).length === 0) {
                    throw new Error("Firebase configuration is missing. Cannot initialize app.");
                }
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('debug'); // Enable Firestore logging

                // Sign in
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

                userId = auth.currentUser?.uid;
                if (!userId) {
                    throw new Error("Authentication failed, user ID is not available.");
                }
                console.log("Authenticated with user ID:", userId);
                
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                const loadingOverlay = document.getElementById('loading-overlay');
                
                let errorMessage;
                if (error.message.includes("Firebase configuration is missing")) {
                     errorMessage = `
                        <div class="text-center p-4">
                            <h2 class="text-xl font-bold text-red-600">Configuration Error</h2>
                            <p class="text-gray-700 mt-2">The Firebase configuration is missing or invalid.</p>
                            <p class="text-gray-600 mt-4 text-sm">Please ensure the app is loaded in the correct environment.</p>
                        </div>`;
                }
                else if (error.code === 'auth/configuration-not-found' || error.message.includes("Authentication failed")) {
                    errorMessage = `
                    <div class="text-center p-4">
                        <h2 class="text-xl font-bold text-red-600">Firebase Authenticatie Fout</h2>
                        <p class="text-gray-700 mt-2">De anonieme inlogmethode is niet geactiveerd in je Firebase-project, or authentication failed.</p>
                        <p class="text-gray-600 mt-4 text-sm"><b>Actie vereist:</b></p>
                        <ol class="text-left text-sm text-gray-600 list-decimal list-inside mt-2 bg-gray-100 p-3 rounded">
                            <li>Ga naar je <a href="https://console.firebase.google.com/" target="_blank" class="text-blue-600 underline">Firebase Console</a>.</li>
                            <li>Selecteer je project: <b>${firebaseConfig.projectId || 'YOUR_PROJECT_ID'}</b>.</li>
                            <li>Ga naar <b>Build > Authentication</b>.</li>
                            <li>Klik op het <b>Sign-in method</b> tabblad.</li>
                            <li>Klik op <b>Anonymous</b> in de lijst en activeer de schakelaar (Enable).</li>
                            <li>Sla op en ververs deze pagina.</li>
                        </ol>
                    </div>`;
                } else {
                        errorMessage = `
                    <div class="text-center p-4">
                        <h2 class="text-xl font-bold text-red-600">Database Connection Failed</h2>
                        <p class="text-gray-700 mt-2">Could not connect to the database.</p>
                        <p class="text-gray-600 mt-4 text-sm">Error: ${error.message}</p>
                    </div>`;
                }
                loadingOverlay.innerHTML = errorMessage;
                return;
            }


            // --- DATABASE & LISTS (Static Config) ---
            const defaultSettings = {
                frequencies: ['Weekly', 'Biweekly', 'Monthly', 'Bimonthly', 'Quarterly', 'Biannual', 'Annual'],
                maintenanceTypes: ['Preventive Maintenance (PM)', 'Corrective Maintenance (CM)', 'Breakdown / Reactive Maintenance', 'Predictive Maintenance (PdM)', 'Condition-Based Maintenance (CBM)', 'Inspections', 'Project Maintenance', 'Ad-hoc work', '3rd Party Maintenance'],
                statuses: ['Open', 'In Progress', 'Completed', 'Postponed'],
                statusColors: {
                    'Open': 'bg-red-500',
                    'In Progress': 'bg-yellow-500',
                    'Completed': 'bg-green-500',
                    'Postponed': 'bg-blue-500'
                    // Note: Colors are not user-configurable in this version
                }
            };
            
            const frequencyInWeeks = { 'Weekly': 1, 'Biweekly': 2, 'Monthly': 4, 'Bimonthly': 8, 'Quarterly': 13, 'Biannual': 26, 'Annual': 52 };
            
            const reportPeriods = {
                weekly: Array.from({ length: 52 }, (_, i) => `Week ${i + 1}`),
                monthly: ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"],
                quarterly: ["Quarter 1 (W1-13)", "Quarter 2 (W14-26)", "Quarter 3 (W27-39)", "Quarter 4 (W40-52)"]
            };

            const weeksInPeriod = {
                "January": {start: 1, end: 4}, "February": {start: 5, end: 8}, "March": {start: 9, end: 13},
                "April": {start: 14, end: 17}, "May": {start: 18, end: 21}, "June": {start: 22, end: 26},
                "July": {start: 27, end: 30}, "August": {start: 31, end: 34}, "September": {start: 35, end: 39},
                "October": {start: 40, end: 43}, "November": {start: 44, end: 47}, "December": {start: 48, end: 52},
                "Quarter 1 (W1-13)": {start: 1, end: 13}, "Quarter 2 (W14-26)": {start: 14, end: 26},
                "Quarter 3 (W27-39)": {start: 27, end: 39}, "Quarter 4 (W40-52)": {start: 40, end: 52},
            };

            // --- STATE MANAGEMENT ---
            let tasks = [];
            let locationConfigs = [];
            let globalSettings = { ...defaultSettings };
            let currentLocationName = null;
            let unsubscribeTasks = () => {};
            let unsubscribeSettings = () => {};
            let expandedAssetNodes = new Set(); // Stores IDs of expanded nodes

            // --- UI ELEMENTS ---
            const loadingOverlay = document.getElementById('loading-overlay');
            const locationSelector = document.getElementById('location-selector');
            const navTabs = document.getElementById('nav-tabs');
            const planningTableBody = document.getElementById('planning-table-body');
            const modal = document.getElementById('task-modal');
            const taskForm = document.getElementById('task-form');
            const weekSelector = document.getElementById('week-selector');
            const addTaskBtn = document.getElementById('add-task-btn');
            const exportCsvBtn = document.getElementById('export-csv-btn');
            const importCsvBtn = document.getElementById('import-csv-btn');
            const csvFileInput = document.getElementById('csv-file-input');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const filterAsset = document.getElementById('filter-asset');
            const filterType = document.getElementById('filter-type');
            const filterStatus = document.getElementById('filter-status');
            const resetFiltersBtn = document.getElementById('reset-filters');
            const addLocationForm = document.getElementById('add-location-form');
            const editLocationSelector = document.getElementById('edit-location-selector');
            const renameLocationBtn = document.getElementById('rename-location-btn');
            const deleteLocationBtn = document.getElementById('delete-location-btn');
            const assetManagerDiv = document.getElementById('asset-manager');
            const reportTypeSelector = document.getElementById('report-type-selector');
            const reportPeriodSelector = document.getElementById('report-period-selector');
            const generatePdfBtn = document.getElementById('generate-pdf-btn');
            const downloadTemplateBtn = document.getElementById('download-template-btn');
            const settingsView = document.getElementById('settings-view');

            // --- CUSTOM MODAL ELEMENTS ---
            const alertModal = document.getElementById('alert-modal');
            const alertTitle = document.getElementById('alert-title');
            const alertMessage = document.getElementById('alert-message');
            const alertOkBtn = document.getElementById('alert-ok-btn');

            const confirmModal = document.getElementById('confirm-modal');
            const confirmMessage = document.getElementById('confirm-message');
            const confirmYesBtn = document.getElementById('confirm-yes-btn');
            const confirmNoBtn = document.getElementById('confirm-no-btn');

            const promptModal = document.getElementById('prompt-modal');
            const promptForm = document.getElementById('prompt-form');
            const promptTitle = document.getElementById('prompt-title');
            const promptMessage = document.getElementById('prompt-message');
            const promptInput = document.getElementById('prompt-input');
            const promptOkBtn = document.getElementById('prompt-ok-btn');
            const promptCancelBtn = document.getElementById('prompt-cancel-btn');

            let confirmCallback = null;
            let promptCallback = null;

            // --- CUSTOM MODAL FUNCTIONS ---
            const showModal = (modalEl) => {
                modalEl.classList.remove('hidden');
                setTimeout(() => modalEl.classList.remove('opacity-0'), 10);
            };

            const hideModal = (modalEl) => {
                modalEl.classList.add('opacity-0');
                setTimeout(() => modalEl.classList.add('hidden'), 300);
            };

            const showAlert = (message, isError = false) => {
                alertMessage.textContent = message;
                alertTitle.textContent = isError ? 'Error' : 'Notification';
                if (isError) {
                    alertOkBtn.classList.replace('bg-indigo-600', 'bg-red-600');
                    alertOkBtn.classList.replace('hover:bg-indigo-700', 'hover:bg-red-700');
                } else {
                    alertOkBtn.classList.replace('bg-red-600', 'bg-indigo-600');
                    alertOkBtn.classList.replace('hover:bg-red-700', 'hover:bg-indigo-700');
                }
                showModal(alertModal);
            };

            const showConfirm = (message, onConfirm) => {
                confirmMessage.textContent = message;
                confirmCallback = onConfirm;
                showModal(confirmModal);
            };

            const showPrompt = (message, onConfirm, title = "Input Required", defaultValue = "") => {
                promptTitle.textContent = title;
                promptMessage.textContent = message;
                promptInput.value = defaultValue;
                promptCallback = onConfirm;
                showModal(promptModal);
                setTimeout(() => promptInput.focus(), 100);
            };
            
            // --- UTILITY FUNCTIONS ---
            const getScheduledWeeks = (task) => {
                const weeks = [];
                // Handle legacy frequency mapping
                const freqName = task.frequency;
                const freq = frequencyInWeeks[freqName] || (globalSettings.frequencies.includes(freqName) ? 52 : 52); // Default to annual if unknown
                if (!freq) return weeks;
                for (let i = task.startWeek; i <= 52; i += freq) { weeks.push(i); }
                return weeks;
            };
            
            const showLoading = () => {
                loadingOverlay.classList.remove('hidden');
                setTimeout(() => loadingOverlay.classList.remove('opacity-0'), 10);
            };

            const hideLoading = () => {
                loadingOverlay.classList.add('opacity-0');
                setTimeout(() => loadingOverlay.classList.add('hidden'), 300);
            };

            const exportToCsv = (filteredTasks) => {
                const headers = ['id', 'Asset', 'Task Description', 'Type', 'Frequency', 'Start Week', 'Time (hrs)', 'Status'];
                const rows = filteredTasks.map(task => [
                    task.id, `"${task.asset.replace(/"/g, '""')}"`, `"${task.description.replace(/"/g, '""')}"`,
                    task.type, task.frequency, task.startWeek, task.time, task.status
                ]);
                let csvContent = "data:text/csv;charset=utf-8," + headers.join(",") + "\n" + rows.map(e => e.join(",")).join("\n");
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                const locationName = currentLocationName.replace(/\s+/g, '_');
                link.setAttribute("download", `maintenance_plan_${locationName}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };
            
            const downloadCsvTemplate = () => {
                const headers = ['asset', 'description', 'type', 'frequency', 'startWeek', 'time', 'status'];
                const locationConfig = locationConfigs.find(p => p.id === currentLocationName);
                let exampleAsset = 'Line 1'; // Default example
                if (locationConfig && locationConfig.assets.length > 0) {
                    exampleAsset = locationConfig.assets[0].name;
                    if (locationConfig.assets[0].children && locationConfig.assets[0].children.length > 0) {
                        exampleAsset = locationConfig.assets[0].children[0].name; // Use a sub-asset if possible
                    }
                }
                const exampleRow = [exampleAsset, 'Monthly inspection', 'Inspections', 'Monthly', '1', '2.5', 'Open'];

                const csvContent = "data:text/csv;charset=utf-8,"
                    + headers.join(",") + "\n"
                    + exampleRow.join(",");

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "maintenance_plan_template.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            // --- PDF GENERATION ---
            const generatePdfReport = () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                const reportType = reportTypeSelector.options[reportTypeSelector.selectedIndex].text;
                const period = reportPeriodSelector.value;
                const title = `${reportType} Report for ${period}`;
                
                doc.setFontSize(18);
                doc.text(title, 14, 22);
                doc.setFontSize(11);
                doc.setTextColor(100);
                doc.text(`Location: ${currentLocationName}`, 14, 30);
                doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 14, 36);

                let periodTasks = [];
                if(reportType === 'Weekly'){
                    const weekNumber = parseInt(period.replace('Week ', ''));
                    periodTasks = tasks.filter(task => getScheduledWeeks(task).includes(weekNumber));
                } else {
                    const { start, end } = weeksInPeriod[period];
                    periodTasks = tasks.filter(task => getScheduledWeeks(task).some(w => w >= start && w <= end));
                }

                const head = [['Asset', 'Description', 'Type', 'Time (hrs)', 'Status']];
                const body = periodTasks.map(t => [t.asset, t.description, t.type, t.time, t.status]);

                if(body.length === 0){
                    doc.text("No tasks found for the selected period.", 14, 50);
                } else {
                    doc.autoTable({
                        startY: 40,
                        head: head,
                        body: body,
                        theme: 'striped',
                        headStyles: { fillColor: [79, 70, 229] }, // Indigo color
                    });
                }
                
                doc.save(`report_${currentLocationName.replace(/\s+/g, '_')}_${period.replace(/\s+/g, '_')}.pdf`);
            };


            // --- DATA HANDLING ---
            const setupInitialData = async () => {
                const locationsCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'locations');
                const locationADocRef = doc(locationsCollectionRef, 'Location A');
                const locationBDocRef = doc(locationsCollectionRef, 'Location B');
                
                try {
                    await runTransaction(db, async (transaction) => {
                        const locationADoc = await transaction.get(locationADocRef);
                        const locationBDoc = await transaction.get(locationBDocRef);

                        if (!locationADoc.exists()) {
                            transaction.set(locationADocRef, {
                                name: 'Location A',
                                assets: [
                                    { id: crypto.randomUUID(), name: 'Line 1', children: [
                                        { id: crypto.randomUUID(), name: '1.1 Packer', children: [] },
                                        { id: crypto.randomUUID(), name: '1.2 Filler', children: [] },
                                        { id: crypto.randomUUID(), name: '1.3 Labeler', children: [] }
                                    ]},
                                    { id: crypto.randomUUID(), name: 'Utilities', children: [
                                        { id: crypto.randomUUID(), name: 'Air Compressor', children: [] },
                                        { id: crypto.randomUUID(), name: 'Boiler', children: [] },
                                        { id: crypto.randomUUID(), name: 'Water System', children: [] }
                                    ]}
                                ]
                            });
                            const task1A = doc(collection(locationADocRef, 'tasks'));
                            transaction.set(task1A, { asset: '1.1 Packer', description: 'Inspect conveyor belt', type: 'Inspections', frequency: 'Monthly', startWeek: 2, time: 1.5, status: 'Completed' });
                            const task2A = doc(collection(locationADocRef, 'tasks'));
                            transaction.set(task2A, { asset: 'Boiler', description: 'Check pressure valve', type: 'Preventive Maintenance (PM)', frequency: 'Weekly', startWeek: 1, time: 0.5, status: 'Open' });
                        }

                        if (!locationBDoc.exists()) {
                            transaction.set(locationBDocRef, {
                                name: 'Location B',
                                assets: [
                                    { id: crypto.randomUUID(), name: 'Main Assembly', children: [
                                        { id: crypto.randomUUID(), name: 'Robot Arm 1', children: [] },
                                        { id: crypto.randomUUID(), name: 'Welding Station', children: [] }
                                    ]},
                                    { id: crypto.randomUUID(), name: 'Finishing Line', children: [
                                        { id: crypto.randomUUID(), name: 'Paint Booth', children: [] },
                                        { id: crypto.randomUUID(), name: 'Drying Oven', children: [] }
                                    ]}
                                ]
                            });
                            const task1B = doc(collection(locationBDocRef, 'tasks'));
                            transaction.set(task1B, { asset: 'Robot Arm 1', description: 'Calibrate sensors', type: 'Corrective Maintenance (CM)', frequency: 'Quarterly', startWeek: 5, time: 4, status: 'Open' });
                        }
                    });
                } catch (e) {
                    console.error("Transaction for initial data failed: ", e);
                    showAlert("Could not create initial sample data. You may need to enable Firestore.", true);
                }
            };

            const listenForGlobalSettings = () => {
                const settingsRef = doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'globalConfig');
                unsubscribeSettings = onSnapshot(settingsRef, (docSnap) => {
                    if (docSnap.exists()) {
                        globalSettings = { ...defaultSettings, ...docSnap.data() };
                    } else {
                        globalSettings = { ...defaultSettings };
                        setDoc(settingsRef, globalSettings).catch(e => console.error("Could not create global settings", e));
                    }
                    
                    // Re-populate all dropdowns that depend on these settings
                    populateDropdown(document.getElementById('maintenance-type'), globalSettings.maintenanceTypes);
                    populateDropdown(document.getElementById('frequency'), globalSettings.frequencies);
                    populateDropdown(document.getElementById('status'), globalSettings.statuses);
                    populateDropdown(filterType, globalSettings.maintenanceTypes, true);
                    populateDropdown(filterStatus, globalSettings.statuses, true);

                    // Re-render settings tab lists
                    renderSettingsLists();
                }, error => {
                    console.error("Error fetching global settings:", error);
                    showAlert(`Error fetching settings: ${error.message}`, true);
                });
            };

            const listenForLocations = () => {
                const locationsCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'locations');
                onSnapshot(locationsCollectionRef, (snapshot) => {
                    locationConfigs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    populateLocationSelector();
                    populateEditLocationSelector();
                    
                    if (!currentLocationName && locationConfigs.length > 0) { 
                        switchLocation(locationConfigs[0].id); 
                    } else if (currentLocationName) {
                        // Refresh asset manager and filters if current location data changed
                        const locationConfig = locationConfigs.find(p => p.id === currentLocationName);
                        if (locationConfig) {
                            renderAssetManager(currentLocationName); // Re-render tree
                            populateAssetTreeOptions(filterAsset, locationConfig.assets || [], true);
                        } else {
                            // The location we were watching was deleted
                            currentLocationName = null;
                            tasks = [];
                            if (locationConfigs.length > 0) {
                                switchLocation(locationConfigs[0].id);
                            }
                        }
                    }
                    if (locationConfigs.length === 0) { 
                        hideLoading(); 
                        showAlert("No locations found. Please add a location in the Settings tab.");
                    }
                }, error => {
                    console.error("Error fetching locations:", error);
                    showAlert(`Error fetching locations: ${error.message}`, true);
                    hideLoading();
                });
            };

            const switchLocation = (locationName) => {
                if (!locationName || currentLocationName === locationName) return;
                showLoading();
                currentLocationName = locationName;
                locationSelector.value = locationName;
                
                const locationConfig = locationConfigs.find(p => p.id === locationName);
                populateAssetTreeOptions(filterAsset, locationConfig?.assets || [], true);
                
                unsubscribeTasks(); // Stop listening to old location's tasks
                
                const tasksCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'locations', locationName, 'tasks');
                unsubscribeTasks = onSnapshot(tasksCollectionRef, (snapshot) => {
                    tasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    applyFiltersAndRender();
                    renderWeeklyView(weekSelector.value || 1);
                    renderYearView();
                    hideLoading();
                }, error => { 
                    console.error(`Error fetching tasks for ${locationName}:`, error); 
                    showAlert(`Error fetching tasks: ${error.message}`, true);
                    hideLoading(); 
                });
            };

            // --- MODAL HANDLING ---
            const openModal = (task = null) => {
                taskForm.reset();
                const locationConfig = locationConfigs.find(p => p.id === currentLocationName);
                populateAssetTreeOptions(document.getElementById('asset'), locationConfig?.assets || []);
                
                if (task) {
                    document.getElementById('modal-title').textContent = 'Edit Task';
                    document.getElementById('task-id').value = task.id;
                    document.getElementById('asset').value = task.asset;
                    document.getElementById('task-description').value = task.description;
                    document.getElementById('maintenance-type').value = task.type;
                    document.getElementById('frequency').value = task.frequency;
                    document.getElementById('start-week').value = task.startWeek;
                    document.getElementById('required-time').value = task.time;
                    document.getElementById('status').value = task.status;
                } else {
                    document.getElementById('modal-title').textContent = 'Add New Task';
                    document.getElementById('task-id').value = '';
                }
                showModal(modal);
            };

            const closeModal = () => {
                hideModal(modal);
            };
            
            // --- DROPDOWN POPULATION ---
            const populateLocationSelector = () => {
                const currentVal = locationSelector.value;
                locationSelector.innerHTML = '';
                locationConfigs.forEach(loc => { locationSelector.innerHTML += `<option value="${loc.id}">${loc.name}</option>`; });
                if (currentVal) locationSelector.value = currentVal;
            };

            const populateEditLocationSelector = () => {
                const currentVal = editLocationSelector.value;
                editLocationSelector.innerHTML = '<option value="" disabled selected>-- Select a location --</option>';
                locationConfigs.forEach(loc => { editLocationSelector.innerHTML += `<option value="${loc.id}">${loc.name}</option>`; });
                if (currentVal) editLocationSelector.value = currentVal;
            };

            const populateDropdown = (selectEl, options, includeAll = false) => {
                const currentVal = selectEl.value;
                selectEl.innerHTML = '';
                if(includeAll) { selectEl.innerHTML += `<option value="All">All</option>`; }
                if (options) {
                    options.forEach(option => { selectEl.innerHTML += `<option value="${option}">${option}</option>`; });
                }
                if (currentVal && Array.from(selectEl.options).some(o => o.value === currentVal)) {
                    selectEl.value = currentVal;
                }
            };

            // New function to populate dropdowns with the asset tree
            const populateAssetTreeOptions = (selectEl, assets, includeAll = false) => {
                const currentVal = selectEl.value;
                let optionsHtml = includeAll ? '<option value="All">All</option>' : '';

                const getOptions = (nodes, level) => {
                    let html = '';
                    const indent = '&nbsp;&nbsp;'.repeat(level);
                    const prefix = level > 0 ? 'L ' : '';
                    nodes.forEach(node => {
                        html += `<option value="${node.name}">${indent}${prefix}${node.name}</option>`;
                        if (node.children && node.children.length > 0) {
                            html += getOptions(node.children, level + 1);
                        }
                    });
                    return html;
                };

                optionsHtml += getOptions(assets, 0);
                selectEl.innerHTML = optionsHtml;

                if (currentVal && Array.from(selectEl.options).some(o => o.value === currentVal)) {
                    selectEl.value = currentVal;
                }
            };

            // --- RENDERING FUNCTIONS ---
            const renderSettingsLists = () => {
                const renderList = (key) => {
                    const container = document.getElementById(`${key}-list`);
                    if (!container) return;
                    container.innerHTML = '';
                    globalSettings[key].forEach(item => {
                        container.innerHTML += `
                            <div class="flex justify-between items-center bg-gray-50 p-2 rounded">
                                <span class="text-sm text-gray-700">${item}</span>
                                <button class="delete-setting-btn text-red-500 hover:text-red-700 font-bold text-xs" data-list-key="${key}" data-value="${item}">✕</button>
                            </div>
                        `;
                    });
                };
                renderList('maintenanceTypes');
                renderList('frequencies');
                renderList('statuses');
            };

            const renderPlanningTable = (filteredTasks = tasks) => {
                planningTableBody.innerHTML = '';
                if(filteredTasks.length === 0) {
                    planningTableBody.innerHTML = `<tr><td colspan="7" class="text-center py-10 text-gray-500">No tasks found.</td></tr>`;
                    return;
                }
                filteredTasks.forEach(task => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${task.asset}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 max-w-xs truncate" title="${task.description}">${task.description}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${task.type}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${task.frequency}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${task.time}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${globalSettings.statusColors[task.status] || 'bg-gray-100 text-gray-800'}">${task.status}</span></td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button class="edit-btn text-indigo-600 hover:text-indigo-900" data-id="${task.id}">Edit</button>
                            <button class="delete-btn text-red-600 hover:text-red-900 ml-4" data-id="${task.id}">Delete</button>
                        </td>`;
                    planningTableBody.appendChild(row);
                });
            };
            
            const renderWeeklyView = (weekNumber) => {
                if(!weekNumber || weekNumber < 1 || weekNumber > 52) {
                    document.getElementById('weekly-task-list').innerHTML = `<tr><td colspan="4" class="text-center py-10 text-gray-500">Select a week number between 1 and 52.</td></tr>`;
                    document.getElementById('weekly-hours-summary').innerHTML = `<p class="text-center text-gray-500">No data to display.</p>`;
                    return;
                }
                document.getElementById('weekly-task-title').textContent = `Tasks for Week ${weekNumber}`;
                document.getElementById('weekly-hours-title').textContent = `Total Hours for Week ${weekNumber}`;
                const weeklyTasks = tasks.filter(task => getScheduledWeeks(task).includes(parseInt(weekNumber)));
                const taskListBody = document.getElementById('weekly-task-list');
                taskListBody.innerHTML = weeklyTasks.length === 0 ? `<tr><td colspan="4" class="text-center py-10 text-gray-500">No tasks scheduled for this week.</td></tr>` :
                    weeklyTasks.map(task => `<tr>
                        <td class="px-4 py-2 text-sm text-gray-900">${task.asset}</td>
                        <td class="px-4 py-2 text-sm text-gray-500">${task.description}</td> <td class="px-4 py-2 text-sm text-gray-500">${task.time}</td>
                        <td class="px-4 py-2 text-sm"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${globalSettings.statusColors[task.status] || 'bg-gray-100 text-gray-800'}">${task.status}</span></td>
                        </tr>`).join('');
                
                const hoursSummary = document.getElementById('weekly-hours-summary');
                hoursSummary.innerHTML = '';
                
                // Group hours by top-level asset
                const locationConfig = locationConfigs.find(p => p.id === currentLocationName);
                const topLevelAssetNames = (locationConfig?.assets || []).map(a => a.name);

                const getTopLevelAsset = (assetName) => {
                    if (topLevelAssetNames.includes(assetName)) return assetName;
                    
                    const findInTree = (nodes) => {
                        for(const node of nodes) {
                            if (node.children?.some(child => child.name === assetName)) return node.name;
                            if (node.children) {
                                const parentName = findInTree(node.children);
                                if (parentName) return node.name; // Return the top-level parent
                            }
                        }
                        return null;
                    };
                    return findInTree(locationConfig?.assets || []) || 'Other';
                };

                const hoursByAsset = weeklyTasks.reduce((acc, task) => { 
                    const topLevel = getTopLevelAsset(task.asset);
                    acc[topLevel] = (acc[topLevel] || 0) + task.time; 
                    return acc; 
                }, {});

                let totalHours = 0;
                Object.entries(hoursByAsset).forEach(([asset, hours]) => {
                    hoursSummary.innerHTML += `<div class="p-3 bg-gray-50 rounded-lg"><div class="flex justify-between items-center"><span class="font-semibold text-gray-700">${asset}</span><span class="font-bold text-indigo-600">${hours.toFixed(1)} hrs</span></div></div>`;
                    totalHours += hours;
                });
                if(Object.keys(hoursByAsset).length === 0){ hoursSummary.innerHTML = `<p class="text-center text-gray-500">No hours logged for this week.</p>`; } 
                else { hoursSummary.innerHTML += `<div class="p-3 bg-gray-100 rounded-lg mt-4 border-t-2 border-gray-200"><div class="flex justify-between items-center"><span class="font-bold text-gray-800">Total</span><span class="font-extrabold text-xl text-indigo-800">${totalHours.toFixed(1)} hrs</span></div></div>`; }
            };

            const renderYearView = () => {
                const container = document.getElementById('year-view-grid-container');
                let headerHtml = `<div class="sticky top-0 z-10 grid year-view-grid bg-gray-100 p-2 rounded-t-lg"><div class="font-semibold text-sm sticky left-0 bg-gray-100 z-10 pl-2">Task</div>`;
                for (let i = 1; i <= 52; i++) { headerHtml += `<div class="text-center text-xs font-mono">${i}</div>`; }
                headerHtml += `</div>`;
                
                let bodyHtml = tasks.map(task => {
                    let row = `<div class="grid year-view-grid border-b border-gray-200"><div class="text-xs font-medium text-gray-600 sticky left-0 bg-white z-10 p-2 border-r truncate" title="${task.asset}">${task.asset}</div>`;
                    const scheduledWeeks = getScheduledWeeks(task);
                    for (let i = 1; i <= 52; i++) {
                        const isScheduled = scheduledWeeks.includes(i);
                        const color = isScheduled ? (globalSettings.statusColors[task.status] || 'bg-gray-400') : 'bg-white';
                        row += `<div class="text-center border-l ${color} h-6" title="Week ${i}: ${isScheduled ? task.description : 'No task'}"></div>`;
                    }
                    row += `</div>`;
                    return row;
                }).join('');

                container.innerHTML = tasks.length > 0 ? headerHtml + bodyHtml : `<p class="text-center py-10 text-gray-500">No tasks to display in the year view.</p>`;
            };

            const renderDashboard = (filteredTasks = tasks) => {
                const statusChart = document.getElementById('status-chart');
                statusChart.innerHTML = '';
                const statusCounts = globalSettings.statuses.reduce((acc, status) => ({ ...acc, [status]: 0 }), {});
                filteredTasks.forEach(task => {
                    if (statusCounts[task.status] !== undefined) {
                        statusCounts[task.status]++;
                    }
                });
                const totalTasks = filteredTasks.length;
                if(totalTasks === 0) { statusChart.innerHTML = `<p class="text-center py-10 text-gray-500">No data for current filters.</p>`; }
                else {
                    globalSettings.statuses.forEach(status => {
                        const count = statusCounts[status];
                        const percentage = ((count / totalTasks) * 100).toFixed(1);
                        statusChart.innerHTML += `<div><div class="flex justify-between mb-1"><span class="text-base font-medium text-gray-700">${status} (${count})</span><span class="text-sm font-medium text-gray-500">${percentage}%</span></div><div class="w-full bg-gray-200 rounded-full h-2.5"><div class="${globalSettings.statusColors[status] || 'bg-gray-400'} h-2.5 rounded-full" style="width: ${percentage}%"></div></div></div>`;
                    });
                }

                const workloadChart = document.getElementById('workload-chart');
                workloadChart.innerHTML = '';
                const weeklyHours = Array(52).fill(0);
                filteredTasks.forEach(task => { getScheduledWeeks(task).forEach(week => { weeklyHours[week-1] += task.time; }); });
                const maxHours = Math.max(...weeklyHours, 1);
                weeklyHours.forEach((hours, index) => {
                    const height = (hours / maxHours) * 100;
                    workloadChart.innerHTML += `<div class="flex-1 group flex flex-col items-center"><span class="text-xs text-gray-500 opacity-0 group-hover:opacity-100 transition-opacity">${hours.toFixed(1)}h</span><div class="chart-bar w-full bg-indigo-200 hover:bg-indigo-400 rounded-t" style="height: ${height > 0 ? Math.max(height, 2) : 0}%" title="Week ${index + 1}: ${hours.toFixed(1)} hours"></div><span class="text-xs text-gray-400">${index+1}</span></div>`;
                });

                const urgentTasksList = document.getElementById('urgent-tasks-list');
                const urgentTasks = filteredTasks.filter(t => t.status === 'Open' || t.status === 'Postponed');
                if(urgentTasks.length > 0) {
                    let table = `<table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Asset</th><th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Task</th><th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Status</th></tr></thead><tbody>`;
                    urgentTasks.forEach(task => { table += `<tr><td class="px-4 py-2 text-sm font-medium">${task.asset}</td><td class="px-4 py-2 text-sm text-gray-600">${task.description}</td><td class="px-4 py-2 text-sm"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${globalSettings.statusColors[task.status] || 'bg-gray-100 text-gray-800'}">${task.status}</span></td></tr>`; });
                    table += `</tbody></table>`;
                    urgentTasksList.innerHTML = table;
                } else { urgentTasksList.innerHTML = `<p class="text-center py-8 text-gray-500">No open or postponed tasks found.</p>`; }
            };

            const applyFiltersAndRender = () => {
                const selectedAsset = filterAsset.value;
                const selectedType = filterType.value;
                const selectedStatus = filterStatus.value;
                
                const locationConfig = locationConfigs.find(p => p.id === currentLocationName);
                const allChildAssets = (assetName) => {
                    let assets = [assetName];
                    const findChildren = (nodes) => {
                        for (const node of nodes) {
                            if (node.name === assetName && node.children) {
                                return node.children.flatMap(child => allChildAssets(child.name));
                            }
                            if (node.children) {
                                const found = findChildren(node.children);
                                if (found) return found;
                            }
                        }
                        return [];
                    };
                    return assets.concat(findChildren(locationConfig?.assets || []));
                };
                
                const assetsToFilter = selectedAsset === 'All' ? [] : allChildAssets(selectedAsset);

                const filtered = tasks.filter(task => 
                    (selectedAsset === 'All' || assetsToFilter.includes(task.asset)) && 
                    (selectedType === 'All' || task.type === selectedType) && 
                    (selectedStatus === 'All' || task.status === selectedStatus)
                );
                renderDashboard(filtered);
                renderPlanningTable(filtered);
            };

            // --- Asset Hierarchy Functions ---
            const renderAssetManager = (locationName) => {
                const locationConfig = locationConfigs.find(p => p.id === locationName);
                if (!locationConfig) { assetManagerDiv.classList.add('hidden'); return; }

                const renderAssetNode = (node, level) => {
                    const isExpanded = expandedAssetNodes.has(node.id);
                    const hasChildren = node.children && node.children.length > 0;
                    const childrenHtml = (isExpanded && hasChildren) ? node.children.map(child => renderAssetNode(child, level + 1)).join('') : '';
                    
                    return `
                        <div class="asset-node-container" style="margin-left: ${level * 20}px;">
                            <div class="asset-node" data-id="${node.id}">
                                <span class="toggle-expand-btn ${hasChildren ? '' : 'empty'}" data-id="${node.id}">
                                    ${hasChildren ? (isExpanded ? '−' : '+') : ' '}
                                </span>
                                <div class="asset-node-content">
                                    <span class="text-sm font-medium text-gray-700">${node.name}</span>
                                </div>
                                <div class="asset-actions">
                                    <button title="Add Child" class="asset-action-btn add-child-btn" data-id="${node.id}">
                                        <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                                    </button>
                                    <button title="Edit" class="asset-action-btn edit-asset-btn" data-id="${node.id}" data-name="${node.name}">
                                        <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                                    </button>
                                    <button title="Delete" class="asset-action-btn delete-asset-btn" data-id="${node.id}" data-name="${node.name}">
                                        <svg class="w-4 h-4 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                                    </button>
                                </div>
                            </div>
                            <div class="asset-children">${childrenHtml}</div>
                        </div>
                    `;
                };

                let html = `<div class="border-t pt-4 space-y-4"><div class="flex justify-between items-center"><h4 class="text-md font-semibold text-gray-800">Assets for ${locationConfig.name}</h4><button id="add-asset-btn" class="bg-blue-500 hover:bg-blue-600 text-white text-sm font-bold py-1 px-3 rounded-md">Add Top-Level Asset</button></div>`;
                if (locationConfig.assets && locationConfig.assets.length > 0) {
                    html += locationConfig.assets.map(asset => renderAssetNode(asset, 0)).join('');
                } else {
                    html += `<p class="text-center py-4 text-gray-500">No assets defined for this location.</p>`;
                }
                html += `</div>`;
                assetManagerDiv.innerHTML = html;
                assetManagerDiv.classList.remove('hidden');
            };

            // Recursive helper functions for tree modification
            const findNode = (nodes, id) => {
                for (const node of nodes) {
                    if (node.id === id) return node;
                    if (node.children) {
                        const found = findNode(node.children, id);
                        if (found) return found;
                    }
                }
                return null;
            };

            const addNode = (nodes, parentId, newNode) => {
                if (parentId === null) { // Adding top-level asset
                    nodes.push(newNode);
                    return true;
                }
                for (const node of nodes) {
                    if (node.id === parentId) {
                        if (!node.children) node.children = [];
                        node.children.push(newNode);
                        return true;
                    }
                    if (node.children && addNode(node.children, parentId, newNode)) {
                        return true;
                    }
                }
                return false;
            };

            const updateNode = (nodes, id, newName) => {
                for (const node of nodes) {
                    if (node.id === id) {
                        node.name = newName;
                        return true;
                    }
                    if (node.children && updateNode(node.children, id, newName)) {
                        return true;
                    }
                }
                return false;
            };

            const deleteNode = (nodes, id) => {
                for (let i = 0; i < nodes.length; i++) {
                    if (nodes[i].id === id) {
                        nodes.splice(i, 1);
                        return true;
                    }
                    if (nodes[i].children && deleteNode(nodes[i].children, id)) {
                        return true;
                    }
                }
                return false;
            };
            
            // --- CSV IMPORT ---
            const handleCsvImport = (event) => {
                const file = event.target.files[0]; if (!file) return;
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const { tasksToUpload, tasksToUpdate, skippedCount, error } = parseCsv(e.target.result);
                    if (error) {
                        showAlert(error, true);
                    } else if (tasksToUpload.length > 0 || tasksToUpdate.length > 0) {
                        showLoading();
                        await processCsvUpload(tasksToUpload, tasksToUpdate);
                        hideLoading();
                        showAlert(`CSV Import Complete:\n- ${tasksToUpload.length} new tasks created.\n- ${tasksToUpdate.length} tasks updated.\n- ${skippedCount} rows skipped.`);
                    } else { showAlert(`Import failed. No valid tasks found to create or update. Skipped ${skippedCount} rows.`, true); }
                    csvFileInput.value = ''; // Reset file input
                };
                reader.readAsText(file);
            };

            const parseCsv = (csvText) => {
                const lines = csvText.split(/\r\n|\n/).filter(line => line.trim() !== '');
                if (lines.length < 2) return { tasksToUpload: [], tasksToUpdate: [], skippedCount: lines.length, error: null };
                
                const headers = lines[0].split(',').map(h => h.trim());
                const requiredHeaders = ['asset', 'description', 'type', 'frequency', 'startWeek', 'time', 'status'];
                if (!requiredHeaders.every(h => headers.includes(h))) {
                    return { tasksToUpload: [], tasksToUpdate: [], skippedCount: lines.length - 1, error: 'CSV is missing required headers:\n' + requiredHeaders.join(', ') };
                }
                
                const tasksToUpload = []; 
                const tasksToUpdate = [];
                let skippedCount = 0;
                
                const locationConfig = locationConfigs.find(p => p.id === currentLocationName);
                if (!locationConfig) { return { tasksToUpload: [], tasksToUpdate: [], skippedCount: lines.length - 1, error: 'Cannot import: No location selected.' }; }
                
                // Create a flat list of all valid asset names for validation
                const allAssetNames = new Set();
                const collectAssetNames = (nodes) => {
                    nodes.forEach(node => {
                        allAssetNames.add(node.name);
                        if(node.children) collectAssetNames(node.children);
                    });
                };
                collectAssetNames(locationConfig.assets || []);

                for (let i = 1; i < lines.length; i++) {
                    const values = lines[i].split(',');
                    const rowData = headers.reduce((obj, h, idx) => { obj[h] = values[idx] ? values[idx].trim().replace(/"/g, '') : ''; return obj; }, {});

                    // --- Validation ---
                    if (!allAssetNames.has(rowData.asset)) {
                        console.warn(`Skipping row ${i+1}: Asset "${rowData.asset}" not found in settings.`);
                        skippedCount++;
                        continue;
                    }
                    if (!globalSettings.maintenanceTypes.includes(rowData.type)) {
                        console.warn(`Skipping row ${i+1}: Type "${rowData.type}" not valid. Defaulting to first.`);
                        rowData.type = globalSettings.maintenanceTypes[0];
                    }
                    if (!globalSettings.frequencies.includes(rowData.frequency)) {
                        console.warn(`Skipping row ${i+1}: Frequency "${rowData.frequency}" not valid. Defaulting to first.`);
                        rowData.frequency = globalSettings.frequencies[0];
                    }
                    if (!globalSettings.statuses.includes(rowData.status)) {
                        console.warn(`Skipping row ${i+1}: Status "${rowData.status}" not valid. Defaulting to first.`);
                        rowData.status = globalSettings.statuses[0];
                    }

                    const taskData = {
                        asset: rowData.asset,
                        description: rowData.description || 'N/A',
                        type: rowData.type,
                        frequency: rowData.frequency,
                        startWeek: parseInt(rowData.startWeek) || 1,
                        time: parseFloat(rowData.time) || 0,
                        status: rowData.status
                    };

                    if (rowData.id) {
                        tasksToUpdate.push({ id: rowData.id, ...taskData });
                    } else {
                        tasksToUpload.push(taskData);
                    }
                }
                return { tasksToUpload, tasksToUpdate, skippedCount, error: null };
            };

            const processCsvUpload = async (tasksToUpload, tasksToUpdate) => {
                const batch = writeBatch(db);
                const tasksCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'locations', currentLocationName, 'tasks');
                
                tasksToUpload.forEach(taskData => { 
                    const newDocRef = doc(tasksCollectionRef); 
                    batch.set(newDocRef, taskData); 
                });
                
                tasksToUpdate.forEach(taskData => {
                    const docRef = doc(tasksCollectionRef, taskData.id);
                    const { id, ...data } = taskData; // Remove id from data object
                    batch.update(docRef, data);
                });

                try { 
                    await batch.commit(); 
                } catch (error) { 
                    console.error("Error batch uploading/updating tasks:", error); 
                    showAlert("CSV import failed: " + error.message, true); 
                }
            };

            // --- EVENT LISTENERS ---
            // --- Custom Modal Event Listeners ---
            alertOkBtn.addEventListener('click', () => hideModal(alertModal));
            
            confirmNoBtn.addEventListener('click', () => {
                hideModal(confirmModal);
                confirmCallback = null;
            });
            
            confirmYesBtn.addEventListener('click', () => {
                hideModal(confirmModal);
                if (confirmCallback) {
                    confirmCallback();
                }
                confirmCallback = null;
            });

            promptCancelBtn.addEventListener('click', () => {
                hideModal(promptModal);
                promptCallback = null;
            });
            
            promptForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const value = promptInput.value.trim();
                if (promptCallback) {
                    promptCallback(value); // Pass value even if empty, let callback decide
                }
                hideModal(promptModal);
                promptCallback = null;
            });

            // --- Application Event Listeners ---
            locationSelector.addEventListener('change', (e) => switchLocation(e.target.value));
            exportCsvBtn.addEventListener('click', () => {
                const filtered = tasks.filter(task => (filterAsset.value === 'All' || task.asset === filterAsset.value) && (filterType.value === 'All' || task.type === filterType.value) && (filterStatus.value === 'All' || task.status === filterStatus.value));
                exportToCsv(filtered);
            });
            downloadTemplateBtn.addEventListener('click', downloadCsvTemplate);
            importCsvBtn.addEventListener('click', () => csvFileInput.click());
            csvFileInput.addEventListener('change', handleCsvImport);
            navTabs.addEventListener('click', (e) => {
                if(e.target.tagName === 'BUTTON'){
                    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
                    document.getElementById(`${e.target.dataset.tab}-view`).classList.remove('hidden');
                }
            });
            taskForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const id = document.getElementById('task-id').value;
                const taskData = {
                    asset: document.getElementById('asset').value,
                    description: document.getElementById('task-description').value, 
                    type: document.getElementById('maintenance-type').value,
                    frequency: document.getElementById('frequency').value, 
                    startWeek: parseInt(document.getElementById('start-week').value),
                    time: parseFloat(document.getElementById('required-time').value), 
                    status: document.getElementById('status').value
                };
                if (!taskData.asset) {
                    showAlert("Asset cannot be empty.", true);
                    return;
                }
                const tasksCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'locations', currentLocationName, 'tasks');
                try {
                    if (id) { await setDoc(doc(tasksCollectionRef, id), taskData); } 
                    else { await addDoc(tasksCollectionRef, taskData); }
                    closeModal();
                } catch(error) { 
                    console.error("Error saving task:", error); 
                    showAlert("Could not save task: " + error.message, true); 
                }
            });
            planningTableBody.addEventListener('click', (e) => {
                if (e.target.classList.contains('edit-btn')) { 
                    openModal(tasks.find(t => t.id === e.target.dataset.id)); 
                }
                if (e.target.classList.contains('delete-btn')) {
                    showConfirm('Are you sure you want to delete this task?', async () => {
                        try { 
                            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'locations', currentLocationName, 'tasks', e.target.dataset.id)); 
                        } catch(error) { 
                            console.error("Error deleting task:", error); 
                            showAlert("Could not delete task: " + error.message, true); 
                        }
                    });
                }
            });
            addLocationForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const newLocationName = document.getElementById('new-location-name').value.trim();
                if (!newLocationName) return;
                
                if (locationConfigs.some(loc => loc.name === newLocationName)) {
                    showAlert("A location with this name already exists.", true);
                    return;
                }

                const locationDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'locations', newLocationName);
                try {
                    await setDoc(locationDocRef, { name: newLocationName, assets: [] });
                    addLocationForm.reset(); 
                    editLocationSelector.value = newLocationName; 
                    renderAssetManager(newLocationName);
                    showAlert(`Location "${newLocationName}" added successfully.`);
                } catch (error) { 
                    console.error("Error adding location:", error); 
                    showAlert("Could not add location: " + error.message, true); 
                }
            });

            // --- Location Management Listeners ---
            editLocationSelector.addEventListener('change', (e) => {
                expandedAssetNodes.clear(); // Clear expansion state when switching locations
                renderAssetManager(e.target.value);
                // Enable/disable buttons
                const hasSelection = !!e.target.value;
                renameLocationBtn.disabled = !hasSelection;
                deleteLocationBtn.disabled = !hasSelection;
            });

            renameLocationBtn.addEventListener('click', () => {
                const oldName = editLocationSelector.value;
                if (!oldName) return;

                showPrompt("Enter new location name:", async (newName) => {
                    if (!newName || newName === oldName) return;

                    if (locationConfigs.some(loc => loc.name === newName)) {
                        showAlert(`A location named "${newName}" already exists.`, true);
                        return;
                    }
                    
                    showLoading();
                    try {
                        const locationsCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'locations');
                        const oldDocRef = doc(locationsCollectionRef, oldName);
                        const newDocRef = doc(locationsCollectionRef, newName);

                        // 1. Get old location data
                        const locationData = (await getDoc(oldDocRef)).data();
                        locationData.name = newName; // Update name field

                        // 2. Set new location doc
                        await setDoc(newDocRef, locationData);

                        // 3. Move all tasks
                        const oldTasksRef = collection(oldDocRef, 'tasks');
                        const newTasksRef = collection(newDocRef, 'tasks');
                        const tasksSnapshot = await getDocs(oldTasksRef);
                        
                        const batch = writeBatch(db);

                        tasksSnapshot.forEach(taskDoc => {
                            // Copy task to new location
                            batch.set(doc(newTasksRef, taskDoc.id), taskDoc.data());
                            // Delete task from old location
                            batch.delete(taskDoc.ref);
                        });

                        // 4. Delete old location doc
                        batch.delete(oldDocRef);

                        // 5. Commit all changes
                        await batch.commit();

                        // 6. Update UI
                        editLocationSelector.value = newName; // This will trigger listeners
                        switchLocation(newName); // Manually switch to be sure
                        showAlert(`Location "${oldName}" renamed to "${newName}".`);

                    } catch (error) {
                        console.error("Error renaming location:", error);
                        showAlert(`Error renaming location: ${error.message}`, true);
                    } finally {
                        hideLoading();
                    }
                }, "Rename Location", oldName);
            });

            deleteLocationBtn.addEventListener('click', () => {
                const locationName = editLocationSelector.value;
                if (!locationName) return;

                showConfirm(`Are you sure you want to delete "${locationName}"? This will delete all associated assets and tasks permanently.`, async () => {
                    showLoading();
                    try {
                        const locationsCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'locations');
                        const locationDocRef = doc(locationsCollectionRef, locationName);
                        
                        // 1. Delete all tasks in sub-collection
                        const tasksRef = collection(locationDocRef, 'tasks');
                        const tasksSnapshot = await getDocs(tasksRef);
                        
                        const batch = writeBatch(db);
                        tasksSnapshot.forEach(taskDoc => {
                            batch.delete(taskDoc.ref);
                        });

                        // 2. Delete parent location doc
                        batch.delete(locationDocRef);

                        // 3. Commit changes
                        await batch.commit();

                        // 4. Update UI
                        assetManagerDiv.classList.add('hidden');
                        renameLocationBtn.disabled = true;
                        deleteLocationBtn.disabled = true;
                        
                        // Switch to another location if one exists
                        if (currentLocationName === locationName) {
                            currentLocationName = null; // Force switch
                            const remainingLocations = locationConfigs.filter(l => l.id !== locationName);
                            if (remainingLocations.length > 0) {
                                switchLocation(remainingLocations[0].id);
                            } else {
                                // No locations left
                                locationSelector.innerHTML = '';
                                editLocationSelector.innerHTML = '<option value="" disabled selected>-- Select a location --</option>';
                                tasks = [];
                                applyFiltersAndRender();
                                renderWeeklyView(weekSelector.value || 1);
                                renderYearView();
                            }
                        }
                        
                        showAlert(`Location "${locationName}" has been deleted.`);
                    } catch (error) {
                        console.error("Error deleting location:", error);
                        showAlert(`Error deleting location: ${error.message}`, true);
                    } finally {
                        hideLoading();
                    }
                });
            });
            
            // --- Asset Manager Event Delegation ---
            assetManagerDiv.addEventListener('click', async (e) => {
                const locationName = editLocationSelector.value; if (!locationName) return;
                const locationRef = doc(db, 'artifacts', appId, 'public', 'data', 'locations', locationName);
                const locationConfig = locationConfigs.find(p => p.id === locationName);
                if (!locationConfig) return;
                
                // Use structuredClone for a deep copy of the assets array
                let assets = structuredClone(locationConfig.assets || []);

                const btn = e.target.closest('.toggle-expand-btn');
                if (btn && !btn.classList.contains('empty')) {
                    const id = btn.dataset.id;
                    if (expandedAssetNodes.has(id)) {
                        expandedAssetNodes.delete(id);
                    } else {
                        expandedAssetNodes.add(id);
                    }
                    renderAssetManager(locationName); // Re-render the tree
                    return; // Stop processing
                }

                if (e.target.closest('#add-asset-btn')) {
                    showPrompt('Enter new top-level asset name:', async (assetName) => {
                        if (assetName) { 
                            const newNode = { id: crypto.randomUUID(), name: assetName, children: [] };
                            addNode(assets, null, newNode); // null parentId = top level
                            await updateDoc(locationRef, { assets });
                            expandedAssetNodes.add(newNode.id); // Expand parent
                        }
                    });
                }

                const addChildBtn = e.target.closest('.add-child-btn');
                if (addChildBtn) {
                    const parentId = addChildBtn.dataset.id;
                    showPrompt('Enter new sub-asset name:', async (assetName) => {
                        if (assetName) { 
                            const newNode = { id: crypto.randomUUID(), name: assetName, children: [] };
                            addNode(assets, parentId, newNode);
                            await updateDoc(locationRef, { assets });
                            expandedAssetNodes.add(parentId); // Expand parent
                        }
                    });
                }

                const editAssetBtn = e.target.closest('.edit-asset-btn');
                if (editAssetBtn) {
                    const id = editAssetBtn.dataset.id;
                    const name = editAssetBtn.dataset.name;
                    showPrompt('Enter new asset name:', async (newName) => {
                        if (newName && newName !== name) {
                            // We need to also update all tasks that reference this asset
                            showLoading();
                            const oldName = name;
                            updateNode(assets, id, newName);
                            await updateDoc(locationRef, { assets });
                            
                            // Update tasks
                            const tasksToUpdate = tasks.filter(t => t.asset === oldName);
                            if (tasksToUpdate.length > 0) {
                                const batch = writeBatch(db);
                                const tasksCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'locations', currentLocationName, 'tasks');
                                tasksToUpdate.forEach(task => {
                                    batch.update(doc(tasksCollectionRef, task.id), { asset: newName });
                                });
                                await batch.commit();
                            }
                            hideLoading();
                            showAlert(`Asset renamed to "${newName}". ${tasksToUpdate.length} tasks were updated.`);
                        }
                    }, 'Edit Asset Name', name);
                }

                const deleteAssetBtn = e.target.closest('.delete-asset-btn');
                if (deleteAssetBtn) {
                    const id = deleteAssetBtn.dataset.id;
                    const name = deleteAssetBtn.dataset.name;
                    // Check if tasks are associated
                    const associatedTasks = tasks.filter(t => t.asset === name);
                    if (associatedTasks.length > 0) {
                        showAlert(`Cannot delete "${name}": It is used by ${associatedTasks.length} task(s). Please re-assign or delete those tasks first.`, true);
                        return;
                    }

                    showConfirm(`Delete asset "${name}"? This cannot be undone.`, async () => {
                        deleteNode(assets, id);
                        await updateDoc(locationRef, { assets });
                    });
                }
            });

            // --- Settings List Event Delegation ---
            settingsView.addEventListener('click', async (e) => {
                const addBtn = e.target.closest('.add-setting-btn');
                const deleteBtn = e.target.closest('.delete-setting-btn');
                const settingsRef = doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'globalConfig');
                
                if (addBtn) {
                    const key = addBtn.dataset.listKey;
                    showPrompt(`Enter new value for ${key}:`, async (value) => {
                        if (value && !globalSettings[key].includes(value)) {
                            const newList = [...globalSettings[key], value];
                            await updateDoc(settingsRef, { [key]: newList });
                        } else if (value) {
                            showAlert("This value already exists.", true);
                        }
                    });
                }

                if (deleteBtn) {
                    const key = deleteBtn.dataset.listKey;
                    const value = deleteBtn.dataset.value;
                    showConfirm(`Are you sure you want to delete "${value}"?`, async () => {
                        // Check if value is in use
                        const tasksInUse = tasks.filter(t => t[key] === value); // Note: key might not be 'type', 'status', 'frequency'
                        if (key === 'maintenanceTypes' && tasks.some(t => t.type === value) ||
                            key === 'frequencies' && tasks.some(t => t.frequency === value) ||
                            key === 'statuses' && tasks.some(t => t.status === value)) {
                                showAlert(`Cannot delete "${value}": It is currently in use by tasks.`, true);
                                return;
                            }
                        
                        const newList = globalSettings[key].filter(item => item !== value);
                        await updateDoc(settingsRef, { [key]: newList });
                    });
                }
            });


            weekSelector.addEventListener('input', (e) => renderWeeklyView(e.target.value));
            [filterAsset, filterType, filterStatus].forEach(el => el.addEventListener('change', applyFiltersAndRender));
            resetFiltersBtn.addEventListener('click', () => { filterAsset.value = 'All'; filterType.value = 'All'; filterStatus.value = 'All'; applyFiltersAndRender(); });
            addTaskBtn.addEventListener('click', () => openModal());
            closeModalBtn.addEventListener('click', closeModal);
            modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
            reportTypeSelector.addEventListener('change', (e) => {
                populateDropdown(reportPeriodSelector, reportPeriods[e.target.value]);
            });
            generatePdfBtn.addEventListener('click', generatePdfReport);
            
            // --- INITIALIZATION ---
            const initialize = async () => {
                // Populate static dropdowns
                populateDropdown(reportPeriodSelector, reportPeriods.weekly);
                
                // Set current week
                const now = new Date(); const start = new Date(now.getFullYear(), 0, 1);
                const diff = (now - start) + ((start.getTimezoneOffset() - now.getTimezoneOffset()) * 60 * 1000);
                const day = Math.floor(diff / (1000 * 60 * 60 * 24));
                weekSelector.value = Math.ceil(day / 7);
                
                await setupInitialData(); // Create sample data if it doesn't exist
                listenForGlobalSettings(); // Listen for settings (this will populate dropdowns)
                listenForLocations(); // This will trigger the first data load for locations & tasks
            };
            
            initialize();
        });
    </script>
</body>
</html>

